<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Cool Blog</title>
  <style>
  :root {
    --bg: #0f0f0f;
    --fg: #f4f4f2;
    --accent: #f9d65d;
    --subtle: #999;
    --link: #79dfff;
    --code-bg: #1c1c1c;
    --code-fg: #ffeebb;
    --border: #333;
    --font-stack: 'Inter', 'Segoe UI', 'Helvetica Neue', sans-serif;
  }

  body {
    font-family: var(--font-stack);
    background-color: var(--bg);
    color: var(--fg);
    margin: 2rem auto;
    max-width: 820px;
    padding: 0 1rem;
    line-height: 1.8;
    font-size: 1.05rem;
  }

  h1, h2, h3 {
    color: var(--accent);
    margin-top: 2rem;
    margin-bottom: 1rem;
    line-height: 1.3;
  }

  .post {
    margin-bottom: 2rem;
    padding-left: 1rem;
    border-left: 4px solid var(--border);
    transition: border-color 0.3s ease;
  }

  .post:hover {
    border-color: var(--accent);
  }

  .post a {
    color: var(--link);
    font-weight: 600;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .post a:hover {
    color: var(--accent);
  }

  .post small {
    display: block;
    color: var(--subtle);
    margin-top: 0.3rem;
    font-size: 0.85rem;
  }

  #content {
    padding-bottom: 4rem;
  }

  #back {
    display: inline-block;
    margin-top: 1rem;
    font-size: 0.9rem;
    color: var(--subtle);
    text-decoration: underline;
    cursor: pointer;
  }

  code, pre {
    background-color: var(--code-bg);
    color: var(--code-fg);
    padding: 0.3rem 0.5rem;
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.95rem;
  }

  pre {
    display: block;
    overflow-x: auto;
    margin: 1rem 0;
    padding: 1rem;
    line-height: 1.6;
  }
</style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<h1 id="blog-title">ðŸ“˜ Blog</h1>
<div id="blog-list">Loading blog posts...</div>
<div id="content" style="display: none;"></div>
<div id="back" style="display: none;" onclick="goHome()">Back</div>

<script>
async function fetchMetadata(filename) {
  const res = await fetch(`blog/${filename}`);
  const text = await res.text();
  const matchString = /^---([\s\S]*?)---/
  const metaMatch = text.match(matchString);
  if (!metaMatch) {return null;}

  const metaLines = metaMatch[1].trim().split('\n');
  const meta = {};
  metaLines.forEach(line => {
    const [key, ...rest] = line.split(':');
    meta[key.trim()] = rest.join(':').trim();
  });

  meta.slug = filename.replace(/\.md$/, '');
  meta.filename = filename;
  meta.body = text.replace(matchString, '').trim();
  return meta;
}

async function loadBlogIndex() {
  const listEl = document.getElementById('blog-list');

  try {
    const res = await fetch('blog/files.json');
    const postsWrapper = await res.json();
    const posts = postsWrapper.value;

    // Clean up
    posts.forEach(post => {
      for (let key in post) {
        if (typeof post[key] === 'string') {
          post[key] = post[key].replace(/\r/g, '');
        }
      }
    });

    // Sort newest first
    posts.sort((a, b) => new Date(b.date) - new Date(a.date));

    listEl.innerHTML = posts.map(post => `
      <div class="post">
        <a onclick="showPost('${post.slug}')">${post.title}</a>
        <small>${post.date}</small>
        <p>${post.description}</p>
      </div>
    `).join('');
  } catch (err) {
    listEl.innerHTML = `<p style="color: red;">Failed to load blog index.</p>`;
    console.error("Failed to fetch blog index: ", err);
  }
}

async function showPost(slug) {
  try{
    const res = await fetch(`blog/files.json`);
    const postsWrapper = await res.json();
    const posts = postsWrapper.value;
    const post = posts.find(p => p.slug === slug);

    if(!post) {
      document.getElementById('content').innerHTML = '<p>Post Not Found</p>';
      return;
    }

    const fileRes = await fetch(`blog/${post.filename}`);
    const text = await fileRes.text();
    const content = text.replace(/^---[\s\S]*?---/, '').trim();
    const html = marked.parse(content);

    document.title = post.title + ' | My Blog'
    document.getElementById('blog-list').style.display = 'none';
    document.getElementById('blog-title').innerText = '';
    document.getElementById('content').style.display = 'block';
    document.getElementById('back').style.display = 'inline-block';
    document.getElementById('content').innerHTML = html;

    history.pushState({}, '', `?post=${slug}`);
  } catch (err) {
    document.getElementById('content').innerHTML = '<p>Error loading post.</p>';
    console.error("Failed to load blog post:", err);
  }
}

function goHome() {
  document.title = 'My Blog';
  history.pushState({}, '', window.location.pathname);
  document.getElementById('blog-list').style.display = 'block';
  document.getElementById('blog-title').innerText = 'ðŸ“˜ Blog';
  document.getElementById('content').style.display = 'none';
  document.getElementById('back').style.display = 'none';
}

// Deep link support
function checkUrl() {
  const params = new URLSearchParams(window.location.search);
  const slug = params.get('post');
  if (slug) {
    showPost(slug);
  } else {
    loadBlogIndex();
  }
}

checkUrl();
</script>

</body>
</html>
